name: Python Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ---- Etapa 1: Executar o código principal ----
  build:
    name: Rodar código principal
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Executar script principal
        run: |
          python main.py

  # ---- Etapa 2: Análise de Segurança Estática (SAST) ----
  sast:
    name: SAST - Análise de Segurança Estática
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Instalar dependências
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Rodar Bandit (SAST)
        run: bandit -r . -f txt -o bandit-report.txt

      - name: Upload do relatório (artefato)
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-bandit
          path: bandit-report.txt

  # ---- Etapa 3: Análise de Segurança Dinâmica (DAST) ----
  dast:
    name: DAST - Análise de Segurança Dinâmica
    runs-on: ubuntu-latest
    needs: sast   # roda só depois do SAST
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Instalar OWASP ZAP
        run: |
          sudo apt-get update
          sudo apt-get install -y wget gnupg
          wget -q -O - https://raw.githubusercontent.com/zaproxy/zaproxy/main/assets/packages.asc | sudo apt-key add -
          echo "deb https://download.opensuse.org/repositories/home:/cabelo/xUbuntu_22.04/ /" | sudo tee /etc/apt/sources.list.d/zaproxy.list
          sudo apt-get update
          sudo apt-get install -y zaproxy

      - name: Executar varredura simulada
        run: echo "Simulação de DAST concluída (nenhum app web para testar)"

name: Python Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # П Etapa 1 - Rodar o c贸digo principal
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c贸digo
        uses: actions/checkout@v4

      - name: Rodar c贸digo principal
        run: |
          python main.py

  #  Etapa 2 - An谩lise de Seguran莽a Est谩tica (SAST)
  sast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do c贸digo
        uses: actions/checkout@v4

      - name: Instalar depend锚ncias
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Rodar Bandit (SAST)
        run: |
          bandit -r . -f txt -o bandit-report.txt

      - name: Upload do relat贸rio (SAST)
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-bandit
          path: bandit-report.txt

  #  Etapa 3 - An谩lise de Seguran莽a Din芒mica (DAST)
  dast:
    runs-on: ubuntu-latest
    needs: sast  # roda depois do SAST
    steps:
      - name: Checkout do c贸digo
        uses: actions/checkout@v4

      - name: Instalar OWASP ZAP
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jre-headless wget
          wget https://github.com/zaproxy/zaproxy/releases/download/v2.15.0/ZAP_2.15.0_Linux.tar.gz
          tar -xvzf ZAP_2.15.0_Linux.tar.gz
          sudo mv ZAP_2.15.0 /opt/zap
          echo "ZAP instalado com sucesso!"

      - name: Executar varredura simulada (DAST)
        run: |
          echo "Rodando OWASP ZAP em modo console..."
          /opt/zap/zap.sh -cmd -quickurl https://example.com -quickout zap_report.html || true
          echo "Varredura conclu铆da (simulada para exemplo acad锚mico)."

      - name: Upload do relat贸rio (DAST)
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-zap
          path: zap_report.html
